version: "3.7"

services:
  greetings:
    container_name: greetings
    image: alderaan/greetings-camunda:${TAG:-latest}
    build:
      context: .
      dockerfile: src/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
    ports:
      - "6543:80"     # app
      - "6643:3500"   # dapr http
      - "65430:50001" # dapr grpc
    depends_on:
      - dapr-placement

  greetings-dapr:
    image: daprio/daprd:1.5.1
    container_name: greetings-dapr
    network_mode: "service:greetings"
    command: ["./daprd",
      "-app-id", "greetings-camunda",
      "-app-port", "80",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-placement-host-address", "dapr-placement:50006",
      "-components-path", "/components"
      ]
    depends_on:
      - greetings
      - dapr-placement
    volumes:
      - "./dapr/components/:/components"
      - "./dapr/configuration/:/configuration"

  dapr-placement:
    image: "daprio/placement:1.5.1"
    container_name: dapr-placement
    command: ["./placement", "-port", "50006"]
    ports:
      - "50006:50006"

  maildev:
    container_name: "maildev"
    image: "maildev/maildev:latest"
    ports:
      - "4000:80"
      - "4025:25"
